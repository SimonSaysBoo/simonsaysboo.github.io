<!DOCTYPE html>
<html>
<head>
  <title>Botpress CSV Import Tool</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    .container { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    button { padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background-color: #45a049; }
    .file-list { margin-top: 15px; }
    .file-item { padding: 8px; margin: 5px 0; background-color: #f9f9f9; border-radius: 3px; }
    .status { margin-top: 10px; padding: 10px; border-radius: 4px; }
    .success { background-color: #dff0d8; color: #3c763d; }
    .error { background-color: #f2dede; color: #a94442; }
    .loading { display: none; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Botpress CSV Import Tool</h1>
  
  <div class="container">
    <h2>Upload CSV File</h2>
    <input type="file" id="csvFile" accept=".csv" />
    <button id="uploadBtn">Upload and Process</button>
    <div id="uploadStatus" class="status"></div>
    <div id="uploadLoading" class="loading">Processing...</div>
  </div>
  
  <div class="container">
    <h2>Available CSV Files</h2>
    <button id="refreshBtn">Refresh List</button>
    <div id="fileList" class="file-list">Loading files...</div>
  </div>
  
  <div class="container">
    <h2>Batch Process Files</h2>
    <button id="batchProcessBtn">Process All Files</button>
    <div id="batchStatus" class="status"></div>
    <div id="batchLoading" class="loading">Processing all files...</div>
  </div>
  
  <script>
    const SUPABASE_URL = 'https://ztgtgvinayyoyxfdkaaq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0Z3RndmluYXl5b3l4ZmRrYWFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjk4NDM2NTMsImV4cCI6MjA0NTQxOTY1M30.P5fxdyQYuOV7S8ZjuFN8D4oK49sHDfj9KLu5QsJ_TY4'; // Replace with your actual anon key
    
    // Function to list available CSV files
    async function listFiles() {
      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/list-botpress-csv`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          const fileListElement = document.getElementById('fileList');
          
          if (data.files.length === 0) {
            fileListElement.innerHTML = '<p>No CSV files found.</p>';
            return;
          }
          
          let html = '';
          data.files.forEach(file => {
            html += `
              <div class="file-item">
                <strong>${file.name}</strong> 
                <span>(${formatFileSize(file.metadata.size)})</span>
                <button onclick="processFile('${file.name}')">Process</button>
              </div>
            `;
          });
          
          fileListElement.innerHTML = html;
        } else {
          document.getElementById('fileList').innerHTML = `<p class="error">Error: ${data.error}</p>`;
        }
      } catch (error) {
        document.getElementById('fileList').innerHTML = `<p class="error">Error: ${error.message}</p>`;
      }
    }
    
    // Function to upload and process a file
    async function uploadFile() {
      const fileInput = document.getElementById('csvFile');
      const file = fileInput.files[0];
      
      if (!file) {
        document.getElementById('uploadStatus').innerHTML = '<p class="error">Please select a file first.</p>';
        return;
      }
      
      if (!file.name.endsWith('.csv')) {
        document.getElementById('uploadStatus').innerHTML = '<p class="error">Please select a CSV file.</p>';
        return;
      }
      
      document.getElementById('uploadLoading').style.display = 'block';
      document.getElementById('uploadStatus').innerHTML = '';
      
      try {
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch(`${SUPABASE_URL}/functions/v1/upload-botpress-csv`, {
          method: 'POST',
          body: formData,
          headers: {
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            // Don't set Content-Type here - browser will set it automatically for FormData
          }
        });
        
        const data = await response.json();
        
        document.getElementById('uploadLoading').style.display = 'none';
        
        if (data.success) {
          document.getElementById('uploadStatus').innerHTML = `
            <p class="success">File uploaded successfully!</p>
            <p>File: ${data.fileName}</p>
            <p>Size: ${formatFileSize(data.fileSize)}</p>
          `;
          
          // Process the file immediately after upload
          await processFile(data.fileName);
          
          // Refresh the file list
          listFiles();
        } else {
          document.getElementById('uploadStatus').innerHTML = `<p class="error">Error: ${data.error}</p>`;
        }
      } catch (error) {
        document.getElementById('uploadLoading').style.display = 'none';
        document.getElementById('uploadStatus').innerHTML = `<p class="error">Error: ${error.message}</p>`;
      }
    }
    
    // Function to process a single file
    async function processFile(fileName) {
      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/process-botpress-csv`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ fileName })
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert(`File processed successfully: ${fileName}\nRecords processed: ${data.recordsProcessed}`);
        } else {
          alert(`Error processing file: ${data.error}`);
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }
    
    // Function to batch process all files
    async function batchProcess() {
      document.getElementById('batchLoading').style.display = 'block';
      document.getElementById('batchStatus').innerHTML = '';
      
      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/batch-process-botpress-csv`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        document.getElementById('batchLoading').style.display = 'none';
        
        if (data.success) {
          document.getElementById('batchStatus').innerHTML = `
            <p class="success">Batch processing completed!</p>
            <p>Files processed: ${data.filesProcessed}</p>
            <p>Total records: ${data.totalRecords}</p>
          `;
        } else {
          document.getElementById('batchStatus').innerHTML = `<p class="error">Error: ${data.error}</p>`;
        }
      } catch (error) {
        document.getElementById('batchLoading').style.display = 'none';
        document.getElementById('batchStatus').innerHTML = `<p class="error">Error: ${error.message}</p>`;
      }
    }
    
    // Helper function to format file size
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' bytes';
      else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      else return (bytes / 1048576).toFixed(1) + ' MB';
    }
    
    // Event listeners
    document.getElementById('refreshBtn').addEventListener('click', listFiles);
    document.getElementById('uploadBtn').addEventListener('click', uploadFile);
    document.getElementById('batchProcessBtn').addEventListener('click', batchProcess);
    
    // Load files on page load
    listFiles();
  </script>
</body>
</html>
