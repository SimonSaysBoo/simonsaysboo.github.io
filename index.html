<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSV Upload and Processing</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .section {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    button {
      padding: 8px 16px;
      margin: 5px;
      cursor: pointer;
    }
    #status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
    }
    .info {
      background-color: #d1ecf1;
      color: #0c5460;
    }
    .log-container {
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      background-color: #f8f9fa;
    }
    .log-entry {
      margin-bottom: 5px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h1>Botpress CSV Upload and Processing</h1>
  
  <div class="section">
    <h2>Step 1: Select CSV File</h2>
    <input type="file" id="csvFile" accept=".csv">
    <p>Select a CSV file to upload (botpress_userdata.csv, botpress_conversations.csv, or kajabi_happihub_contacts.csv)</p>
  </div>
  
  <div class="section">
    <h2>Step 2: Upload File</h2>
    <button onclick="uploadFile()">Upload</button>
    <p>Upload the selected CSV file to the server</p>
  </div>
  
  <div class="section">
    <h2>Step 3: Process File</h2>
    <button onclick="processFile()">Process</button>
    <p>Process the uploaded CSV file and insert/update records in the database</p>
  </div>
  
  <div class="section">
    <h2>Batch Processing</h2>
    <button onclick="batchProcessFiles()">Batch Process All Files</button>
    <p>Process all uploaded CSV files in a single batch operation</p>
  </div>
  
  <div id="status" class="info">Ready to upload and process files.</div>
  
  <div class="log-container">
    <h2>Activity Log</h2>
    <div id="logEntries"></div>
  </div>
  
  <script>
    // Your Supabase configuration
    const SUPABASE_URL = 'https://ztgtgvinayyoyxfdkaaq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0Z3RndmluYXl5b3l4ZmRrYWFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjk4NDM2NTMsImV4cCI6MjA0NTQxOTY1M30.P5fxdyQYuOV7S8ZjuFN8D4oK49sHDfj9KLu5QsJ_TY4'; // Replace with your actual anon key
    
    // Logging function
    function logActivity(message, type = 'info') {
      const logContainer = document.getElementById('logEntries');
      const timestamp = new Date().toISOString();
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry ${type}`;
      logEntry.textContent = `[${timestamp}] ${message}`;
      logContainer.prepend(logEntry);
      console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    // Status update function
    function updateStatus(message, type = 'info') {
      const statusElement = document.getElementById('status');
      statusElement.textContent = message;
      statusElement.className = type;
      logActivity(message, type);
    }
    
    async function uploadFile() {
      const fileInput = document.getElementById('csvFile');
      const file = fileInput.files[0];
      
      if (!file) {
        updateStatus('Please select a file first.', 'error');
        return;
      }
      
      try {
        updateStatus(`Uploading file: ${file.name}...`, 'info');
        
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch('https://ztgtgvinayyoyxfdkaaq.supabase.co/functions/v1/upload-botpress-csv', {
          method: 'POST',
          body: formData,
          headers: {
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            // Don't set Content-Type for FormData
          }
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Server responded with ${response.status}: ${errorText}`);
        }
        
        const result = await response.json();
        logActivity(`Upload response: ${JSON.stringify(result)}`, 'info');
        
        if (result.success) {
          updateStatus(`File uploaded successfully: ${file.name}`, 'success');
        } else {
          throw new Error(result.error || 'Unknown error during upload');
        }
      } catch (error) {
        console.error('Upload error:', error);
        updateStatus(`Upload failed: ${error.message}`, 'error');
      }
    }
    
    async function processFile() {
      const fileInput = document.getElementById('csvFile');
      const file = fileInput.files[0];
      
      if (!file) {
        updateStatus('Please select a file first.', 'error');
        return;
      }
      
      try {
        updateStatus(`Processing file: ${file.name}...`, 'info');
        
        const response = await fetch('https://ztgtgvinayyoyxfdkaaq.supabase.co/functions/v1/process-botpress-csv', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({ fileName: file.name })
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Server responded with ${response.status}: ${errorText}`);
        }
        
        const result = await response.json();
        logActivity(`Processing response: ${JSON.stringify(result)}`, 'info');
        
        if (result.success) {
          const details = result.result || {};
          updateStatus(
            `Processing successful! File: ${file.name}, Total rows: ${details.totalRows || 'N/A'}, ` +
            `Valid rows: ${details.validRows || 'N/A'}, Unique rows: ${details.uniqueRows || 'N/A'}`,
            'success'
          );
        } else {
          throw new Error(result.error || 'Unknown error during processing');
        }
      } catch (error) {
        console.error('Processing error:', error);
        updateStatus(`Processing failed: ${error.message}`, 'error');
      }
    }
    
    async function batchProcessFiles() {
      try {
        updateStatus('Starting batch processing of all files...', 'info');
        
        const response = await fetch('https://ztgtgvinayyoyxfdkaaq.supabase.co/functions/v1/batch-process-botpress-csv', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({})
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Server responded with ${response.status}: ${errorText}`);
        }
        
        const result = await response.json();
        logActivity(`Batch processing response: ${JSON.stringify(result)}`, 'info');
        
        if (result.success) {
          const details = result.results || [];
          const summary = details.map(r => `${r.fileName}: ${r.validRows || 0} rows`).join(', ');
          updateStatus(`Batch processing successful! ${summary}`, 'success');
        } else {
          throw new Error(result.error || 'Unknown error during batch processing');
        }
      } catch (error) {
        console.error('Batch processing error:', error);
        updateStatus(`Batch processing failed: ${error.message}`, 'error');
      }
    }
  </script>
</body>
</html>
