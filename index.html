<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Botpress CSV Import System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #333;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .file-input {
            margin-bottom: 15px;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
        }
        .warning {
            background-color: #fcf8e3;
            color: #8a6d3b;
        }
        .db-action {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .danger-button {
            background-color: #dc3545;
        }
        .danger-button:hover {
            background-color: #c82333;
        }
        .success-button {
            background-color: #28a745;
        }
        .success-button:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <h1>Botpress CSV Import System</h1>
    
    <!-- Database View Management - DROP VIEW -->
    <div class="db-action">
        <h2>Step 1: Drop Impact Report View</h2>
        <p>Before importing data, you must drop the impact_report view. Click the button below to drop the view:</p>
        <button id="dropViewBtn" class="danger-button" onclick="dropView()">DROP Impact Report View</button>
        <div id="dropViewStatus"></div>
    </div>

    <div class="section">
        <h2>Step 2: Upload CSV Files</h2>
        <p>Select a CSV file to upload:</p>
        
        <div class="file-input">
            <input type="file" id="csvFile" accept=".csv">
            <button onclick="uploadFile()">Upload</button>
        </div>
        
        <h3>Available Files:</h3>
        <div id="fileList">Loading files...</div>
    </div>
    
    <div class="section">
        <h2>Step 3: Process Files</h2>
        <p>Select a file to process:</p>
        <select id="fileSelect">
            <option value="">-- Select a file --</option>
        </select>
        <button onclick="processFile()">Process</button>
        <button onclick="batchProcess()">Process All Files</button>
    </div>
    
    <div id="status"></div>
    
    <!-- Database View Management - RECREATE VIEW -->
    <div class="db-action">
        <h2>Step 4: Recreate Impact Report View</h2>
        <p>After importing all data, recreate the impact_report view. Click the button below to recreate the view:</p>
        <button id="recreateViewBtn" class="success-button" onclick="recreateView()">RECREATE Impact Report View</button>
        <div id="recreateViewStatus"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ztgtgvinayyoyxfdkaaq.supabase.co';
        const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0Z3RndmluYXl5b3l4ZmRrYWFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDg0NTM5NzcsImV4cCI6MjAyNDAyOTk3N30.Nh8yCZnDMnYQvmYJPGYLLksbO58wR0PrKKKwvSajkJM';
        
        // Fetch the list of files when the page loads
        window.onload = function() {
            fetchFiles();
        };
        
        async function fetchFiles() {
            try {
                document.getElementById('fileList').innerHTML = 'Loading files...';
                
                const response = await fetch(`${SUPABASE_URL}/functions/v1/list-botpress-csv`, {
                    method: 'GET',
                    headers: {
                        'apikey': ANON_KEY,
                        'Authorization': `Bearer ${ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    updateFileList(data.files);
                } else {
                    document.getElementById('fileList').innerHTML = `<p class="error">Error: ${data.error || 'Unknown error'}</p>`;
                    console.error('Error fetching files:', data.error);
                }
            } catch (error) {
                document.getElementById('fileList').innerHTML = `<p class="error">Error: ${error.message}</p>`;
                console.error('Error fetching files:', error);
                showStatus('Error fetching files: ' + error.message, 'error');
            }
        }
        
        function updateFileList(files) {
            const fileListElement = document.getElementById('fileList');
            const fileSelectElement = document.getElementById('fileSelect');
            
            // Clear existing options except the first one
            while (fileSelectElement.options.length > 1) {
                fileSelectElement.remove(1);
            }
            
            if (!files || files.length === 0) {
                fileListElement.innerHTML = '<p>No files uploaded yet.</p>';
                return;
            }
            
            let html = '<ul>';
            files.forEach(file => {
                const fileSize = file.metadata && file.metadata.size ? formatBytes(file.metadata.size) : 'Unknown size';
                html += `<li>${file.name} (${fileSize})</li>`;
                
                const option = document.createElement('option');
                option.value = file.name;
                option.textContent = file.name;
                fileSelectElement.appendChild(option);
            });
            html += '</ul>';
            
            fileListElement.innerHTML = html;
        }
        
        function formatBytes(bytes, decimals = 2) {
            if (!bytes || bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
        
        async function uploadFile() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('Please select a file to upload', 'warning');
                return;
            }
            
            showStatus('Uploading file...', '');
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/upload-botpress-csv`, {
                    method: 'POST',
                    headers: {
                        'apikey': ANON_KEY,
                        'Authorization': `Bearer ${ANON_KEY}`
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus(`File uploaded successfully: ${file.name}`, 'success');
                    fetchFiles(); // Refresh the file list
                } else {
                    showStatus('Error uploading file: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            }
        }
        
        async function processFile() {
            const fileSelect = document.getElementById('fileSelect');
            const fileName = fileSelect.value;
            
            if (!fileName) {
                showStatus('Please select a file to process', 'warning');
                return;
            }
            
            showStatus(`Processing file: ${fileName}...`, '');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/process-botpress-csv`, {
                    method: 'POST',
                    headers: {
                        'apikey': ANON_KEY,
                        'Authorization': `Bearer ${ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fileName })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const result = data.result;
                    showStatus(`
                        File processed successfully: ${result.fileName}<br>
                        Total rows: ${result.totalRows}<br>
                        Valid rows: ${result.validRows}<br>
                        Unique rows inserted: ${result.uniqueRows}<br>
                        Table: ${result.tableName}
                    `, 'success');
                } else {
                    showStatus('Error processing file: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            }
        }
        
        async function batchProcess() {
            showStatus('Starting batch processing...', '');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/batch-process-botpress-csv`, {
                    method: 'POST',
                    headers: {
                        'apikey': ANON_KEY,
                        'Authorization': `Bearer ${ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    let resultHtml = 'Batch processing completed:<br><ul>';
                    data.results.forEach(result => {
                        resultHtml += `<li>${result.fileName}: ${result.status} (${result.message || ''})</li>`;
                    });
                    resultHtml += '</ul>';
                    
                    showStatus(resultHtml, 'success');
                } else {
                    showStatus('Error in batch processing: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            }
        }
        
        function showStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.innerHTML = message;
            statusElement.className = type;
        }
        
        // New function to drop the impact_report view
        async function dropView() {
            const statusElement = document.getElementById('dropViewStatus');
            statusElement.innerHTML = 'Dropping view...';
            statusElement.className = '';
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/sql-execute`, {
                    method: 'POST',
                    headers: {
                        'apikey': ANON_KEY,
                        'Authorization': `Bearer ${ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        sql: 'DROP VIEW IF EXISTS impact_report;' 
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    statusElement.innerHTML = 'View dropped successfully!';
                    statusElement.className = 'success';
                } else {
                    statusElement.innerHTML = 'Error dropping view: ' + (data.error || 'Unknown error');
                    statusElement.className = 'error';
                }
            } catch (error) {
                statusElement.innerHTML = 'Error: ' + error.message;
                statusElement.className = 'error';
            }
        }
        
        // New function to recreate the impact_report view
        async function recreateView() {
            const statusElement = document.getElementById('recreateViewStatus');
            statusElement.innerHTML = 'Recreating view...';
            statusElement.className = '';
            
            const createViewSQL = `
                DROP VIEW IF EXISTS impact_report;

                CREATE VIEW public.impact_report AS
                SELECT
                    c.*,  -- All columns from botpress_conversations
                    u."ud_kajabi_member_id",
                    k.*,  -- All columns from kajabi_happihub_contacts
                    kt."kj_tag",
                    kp."kj_product",
                    bt."bc_conv_topic",
                    be."bc_escalation"
                FROM
                    public.botpress_conversations c
                LEFT JOIN
                    public.botpress_userdata u ON c."bc_conversation_id" = u."ud_conversation_id"
                LEFT JOIN
                    public.kajabi_happihub_contacts k ON u."ud_kajabi_member_id" = k."kj_kajabi_member_id"
                LEFT JOIN
                    public."kj_tags_array" kt ON k."kj_kajabi_member_id" = kt."kj_kajabi_member_id"
                LEFT JOIN
                    public."kj_products_array" kp ON k."kj_kajabi_member_id" = kp."kj_kajabi_member_id"
                LEFT JOIN
                    public."bc_conv_topics_array" bt ON c."bc_conversation_id" = bt."bc_conversation_id"
                LEFT JOIN
                    public."bc_escalations_array" be ON c."bc_conversation_id" = be."bc_conversation_id";
            `;
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/sql-execute`, {
                    method: 'POST',
                    headers: {
                        'apikey': ANON_KEY,
                        'Authorization': `Bearer ${ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        sql: createViewSQL 
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    statusElement.innerHTML = 'View recreated successfully!';
                    statusElement.className = 'success';
                } else {
                    statusElement.innerHTML = 'Error recreating view: ' + (data.error || 'Unknown error');
                    statusElement.className = 'error';
                }
            } catch (error) {
                statusElement.innerHTML = 'Error: ' + error.message;
                statusElement.className = 'error';
            }
        }
    </script>
</body>
</html>
